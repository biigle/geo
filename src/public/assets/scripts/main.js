biigle.$viewModel("geo-image-location-panel",function(e){var t=biigle.$require("geo.image");new Vue({el:e,data:{images:[t]},components:{imageMap:biigle.$require("geo.components.imageMap")}})}),biigle.$viewModel("geo-navbar",function(e){var t=biigle.$require("events"),i=biigle.$require("geo.images");new Vue({el:e,data:{number:i.length,loading:!1},created:function(){var e=this;t.$on("loading.start",function(){e.loading=!0}),t.$on("loading.stop",function(){e.loading=!1}),t.$on("imageMap.update",function(t){e.number=t.length})}})}),biigle.$viewModel("geo-sidebar",function(e){var t=biigle.$require("events");new Vue({el:e,data:{labelTrees:biigle.$require("geo.labelTrees")},components:{sidebar:biigle.$require("core.components.sidebar"),sidebarTab:biigle.$require("core.components.sidebarTab"),labelTrees:biigle.$require("labelTrees.components.labelTrees")},methods:{handleSidebarToggle:function(){this.$nextTick(function(){t.$emit("sidebar.toggle")})},handleSelect:function(e){t.$emit("label.selected",e)},handleDeselect:function(e){t.$emit("label.deselected",e)},handleCleared:function(){t.$emit("label.cleared")}}})}),biigle.$viewModel("project-geo-map",function(e){var t=biigle.$require("geo.project.id"),i=biigle.$require("geo.api.projectImageWithLabel");new Vue({el:e,mixins:[biigle.$require("geo.mixins.geoMap")],methods:{getImageFilterApi:function(e){return i.get({pid:t,lid:e},{})}}})}),biigle.$viewModel("volume-geo-map",function(e){var t=biigle.$require("geo.volume.id"),i=biigle.$require("geo.api.volumeImageWithLabel");new Vue({el:e,mixins:[biigle.$require("geo.mixins.geoMap")],data:{key:"biigle.geo.imageSequence."+t},computed:{selectedImages:function(){return JSON.parse(localStorage.getItem(this.key))||[]}},methods:{handleSelectedImages:function(e){e.length>0?localStorage.setItem(this.key,JSON.stringify(e)):localStorage.removeItem(this.key)},getImageFilterApi:function(e){return i.get({vid:t,lid:e},{})}}})}),biigle.$component("geo.components.imageMap",{template:'<div class="image-map"></div>',props:{images:{type:Array,required:!0},preselected:{type:Array,default:function(){return[]}},interactive:{type:Boolean,default:!0},zoom:{type:Number},selectable:{type:Boolean,default:!1},overlays:{type:Array,default:function(){return[]}}},data:function(){return{source:new ol.source.Vector}},computed:{imagesWithGps:function(){return this.images.filter(function(e){return null!==e.lat&&null!==e.lng})},features:function(){var e={};return this.preselected.forEach(function(t){e[t]=null}),this.imagesWithGps.map(function(t){return new ol.Feature({id:t.id,preselected:e.hasOwnProperty(t.id),geometry:new ol.geom.Point(ol.proj.fromLonLat([t.lng,t.lat]))})})}},methods:{parseSelectedFeatures:function(e){return e.getArray().map(function(e){return e.get("id")})}},watch:{features:function(e){this.source.clear(),this.source.addFeatures(e)}},mounted:function(){var e=biigle.$require("geo.ol.style"),t=biigle.$require("events"),i=this;this.source.addFeatures(this.features);var l=this.source.getExtent(),o=new ol.layer.Tile({source:new ol.source.OSM}),a=new ol.layer.Vector({source:this.source,style:e.default,updateWhileAnimating:!0,updateWhileInteracting:!0}),n=[o];Array.prototype.push.apply(n,this.overlays),n.push(a);var r=new ol.Map({target:this.$el,layers:n,view:new ol.View,interactions:ol.interaction.defaults({altShiftDragRotate:!1,doubleClickZoom:this.interactive,keyboard:this.interactive,mouseWheelZoom:this.interactive,shiftDragZoom:!1,dragPan:this.interactive,pinchRotate:!1,pinchZoom:this.interactive}),controls:ol.control.defaults({zoom:this.interactive})});if(r.getView().fit(l,r.getSize()),this.zoom&&r.getView().setZoom(this.zoom),this.interactive&&(r.addControl(new ol.control.ScaleLine),r.addControl(new ol.control.ZoomToExtent({extent:l,label:""})),r.addControl(new ol.control.OverviewMap({collapsed:!1,collapsible:!1,layers:[o],view:new ol.View({zoom:1,maxZoom:1})}))),this.selectable){var s=new ol.interaction.Select({style:e.selected,features:this.features.filter(function(e){return e.get("preselected")})}),c=s.getFeatures();r.addInteraction(s),s.on("select",function(e){i.$emit("select",i.parseSelectedFeatures(c))});var d=new ol.interaction.DragBox({condition:ol.events.condition.platformModifierKeyOnly});r.addInteraction(d),d.on("boxend",function(){c.clear(),i.source.forEachFeatureIntersectingExtent(d.getGeometry().getExtent(),function(e){c.push(e)}),i.$emit("select",i.parseSelectedFeatures(c))})}t.$on("sidebar.toggle",function(){r.updateSize()}),this.$nextTick(function(){r.updateSize()})}}),biigle.$declare("geo.api.projectImageWithLabel",Vue.resource("api/v1/projects{/pid}/images/filter/annotation-label{/lid}",{})),biigle.$declare("geo.api.volumeImageWithLabel",Vue.resource("api/v1/volumes{/vid}/images/filter/annotation-label{/lid}",{})),biigle.$declare("geo.mixins.geoMap",{components:{imageMap:biigle.$require("geo.components.imageMap")},data:{selectedLabels:[],filteredImageCache:{}},computed:{events:function(){return biigle.$require("events")},allImages:function(){return biigle.$require("geo.images")},filteredImages:function(){var e=[];if(this.selectedLabels.length>0){ids=this.filteredImageCache[this.selectedLabels[0]],Array.prototype.push.apply(e,ids);for(var t=this.selectedLabels.length-1;t>=0;t--){ids=this.filteredImageCache[this.selectedLabels[t]];for(var i=ids.length-1;i>=0;i--)-1===e.indexOf(ids[i])&&e.push(ids[i])}}return e},images:function(){if(this.selectedLabels.length>0){var e=this;return this.allImages.filter(function(t){return-1!==e.filteredImages.indexOf(t.id)})}return this.allImages},baseOverlays:function(){return biigle.$require("geo.overlays")},overlays:function(){var e=biigle.$require("geo.overlayUrl");return this.baseOverlays.map(function(t){return new ol.layer.Image({source:new ol.source.ImageStatic({url:e.replace("{id}",t.id),imageExtent:[t.top_left_lng,t.bottom_right_lat,t.bottom_right_lng,t.top_left_lat],projection:"EPSG:4326"})})})}},methods:{addSelectedLabel:function(e){-1===this.selectedLabels.indexOf(e.id)&&this.selectedLabels.push(e.id)},handleSelectedLabel:function(e){this.filteredImageCache.hasOwnProperty(e.id)?this.addSelectedLabel(e):(this.events.$emit("loading.start"),this.getImageFilterApi(e.id).bind(this).then(function(t){this.filteredImageCache[e.id]=t.data,this.addSelectedLabel(e)},function(t){this.handleDeselectedLabel(e),biigle.$require("messages.store").handleErrorResponse(t)}).finally(function(){this.events.$emit("loading.stop")}))},handleDeselectedLabel:function(e){var t=this.selectedLabels.indexOf(e.id);-1!==t&&this.selectedLabels.splice(t,1)},handleClearedLabels:function(){this.selectedLabels.splice(0)}},watch:{images:function(e){this.events.$emit("imageMap.update",e)}},created:function(){this.events.$on("label.selected",this.handleSelectedLabel),this.events.$on("label.deselected",this.handleDeselectedLabel),this.events.$on("label.cleared",this.handleClearedLabels)}}),biigle.$declare("geo.ol.style",function(){var e={colors:{blue:"#0099ff",white:"#ffffff",orange:"#ff5e00"},radius:{default:6},strokeWidth:{default:2}};return ol&&(e.default=new ol.style.Style({image:new ol.style.Circle({radius:e.radius.default,fill:new ol.style.Fill({color:e.colors.blue}),stroke:new ol.style.Stroke({color:e.colors.white,width:e.strokeWidth.default})})}),e.selected=new ol.style.Style({image:new ol.style.Circle({radius:e.radius.default,fill:new ol.style.Fill({color:e.colors.orange}),stroke:new ol.style.Stroke({color:e.colors.white,width:e.strokeWidth.default})}),zIndex:1/0})),e});